<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Bootstrap 101 Template</title>

    <link href="../bower_components/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
    <link href="../bower_components/jquery-ui/themes/base/jquery-ui.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../dist/gridstack.css"/>

    <style type="text/css">
        .grid-stack {
            background: lightgoldenrodyellow;
        }

        .grid-stack-item-content {
            color: #2c3e50;
            text-align: center;
            background-color: #18bc9c;
        }

        [class*="col-"] {
            padding-top: 15px;
            padding-bottom: 15px;
            background-color: rgba(86,61,124,.15);
            border: 1px solid rgba(86,61,124,.2);
        }
    </style>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="../bower_components/jquery/dist/jquery.min.js"></script>
    <script src="../bower_components/jquery-ui/jquery-ui.js"></script>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-md-4 resizable">test</div>
            <div class="col-md-4 resizable">test</div>
        </div>
    </div>

    <div class="container-fluid">
        <div>
            <a class="btn btn-default" id="add-new-widget" href="#">Add Widget</a>
        </div>

        <br/>

        <div class="grid-stack">
        </div>
    </div>

    <script type="text/javascript">
        $(document).ready(function () {
            $.ui.plugin.add( "resizable", "bootstrapGrid", {

                start: function() {
                    this.cols = 1;
                    this.oldClass = "";
                    var classList = this[0].className.split(/\s+/);
                    for (var i = 0; i < classList.length; i++) {
                        var match = classList[i].match(/col-md-(.*)/i);
                        if (match) {
                            this.cols = parseInt(match[1]);
                            this.oldClass = classList[i];
                        }
                    }
                    this.ppc = Math.floor(this[0].offsetWidth / this.cols);
                },

                stop: function() {
                    console.log('stop');
                },

                resize: function() {

                    var outerDimensions,
                        that = $( this ).resizable( "instance" ),
                        o = that.options,
                        cs = that.size,
                        os = that.originalSize,
                        op = that.originalPosition,
                        a = that.axis,
                        grid = typeof o.bootstrapGrid === "number" ? [ o.bootstrapGrid, o.bootstrapGrid ] : o.bootstrapGrid,
                        gridX = ( grid[ 0 ] || 1 ),
                        gridY = ( grid[ 1 ] || 1 ),
                        ox = Math.round( ( cs.width - os.width ) / gridX ) * gridX,
                        oy = Math.round( ( cs.height - os.height ) / gridY ) * gridY,
                        newWidth = os.width + ox,
                        newHeight = os.height + oy,
                        isMaxWidth = o.maxWidth && ( o.maxWidth < newWidth ),
                        isMaxHeight = o.maxHeight && ( o.maxHeight < newHeight ),
                        isMinWidth = o.minWidth && ( o.minWidth > newWidth ),
                        isMinHeight = o.minHeight && ( o.minHeight > newHeight );

                    o.bootstrapGrid = grid;

                    if ( isMinWidth ) {
                        newWidth += gridX;
                    }
                    if ( isMinHeight ) {
                        newHeight += gridY;
                    }
                    if ( isMaxWidth ) {
                        newWidth -= gridX;
                    }
                    if ( isMaxHeight ) {
                        newHeight -= gridY;
                    }

                    var currentCol = Math.round(ox / this.ppc);
                    var newCols = this.cols + currentCol > 0 ? this.cols + currentCol : 1;
                    var newClass = "col-md-" + newCols;
//                    console.log(this.ppc, ox, currentCol, this.cols + currentCol, newCols);

                    newWidth = os.width;
                    newHeight = os.height;
                    $($(this)[0]).attr('data-test', this.ppc);

                    $(this).removeClass(this.oldClass).addClass(newClass);
                    this.oldClass = newClass;

                    if ( /^(se|s|e)$/.test( a ) ) {
                        that.size.width = newWidth;
                        that.size.height = newHeight;
                    } else if ( /^(ne)$/.test( a ) ) {
                        that.size.width = newWidth;
                        that.size.height = newHeight;
                        that.position.top = op.top - oy;
                    } else if ( /^(sw)$/.test( a ) ) {
                        that.size.width = newWidth;
                        that.size.height = newHeight;
                        that.position.left = op.left - ox;
                    } else {
                        if ( newHeight - gridY <= 0 || newWidth - gridX <= 0 ) {
                            outerDimensions = that._getPaddingPlusBorderDimensions( this );
                        }

                        if ( newHeight - gridY > 0 ) {
                            that.size.height = newHeight;
                            that.position.top = op.top - oy;
                        } else {
                            newHeight = gridY - outerDimensions.height;
                            that.size.height = newHeight;
                            that.position.top = op.top + os.height - newHeight;
                        }
                        if ( newWidth - gridX > 0 ) {
                            that.size.width = newWidth;
                            that.position.left = op.left - ox;
                        } else {
                            newWidth = gridX - outerDimensions.width;
                            that.size.width = newWidth;
                            that.position.left = op.left + os.width - newWidth;
                        }
                    }
                }

            } );

            $( ".resizable" ).resizable({
                bootstrapGrid: [50, 50]
            });
        });

        $(function () {
            var options = {
                float: true
            };
            $('.grid-stack').gridstack(options);

            new function () {
                this.items = [
                    {x: 0, y: 0, width: 2, height: 2},
                    {x: 3, y: 1, width: 1, height: 2},
                    {x: 4, y: 1, width: 1, height: 1},
                    {x: 2, y: 3, width: 3, height: 1},
    //                    {x: 1, y: 4, width: 1, height: 1},
    //                    {x: 1, y: 3, width: 1, height: 1},
    //                    {x: 2, y: 4, width: 1, height: 1},
                    {x: 2, y: 5, width: 1, height: 1}
                ];

                this.grid = $('.grid-stack').data('gridstack');

                this.addNewWidget = function () {
                    var node = this.items.pop() || {
                            x: 12 * Math.random(),
                            y: 5 * Math.random(),
                            width: 1 + 3 * Math.random(),
                            height: 1 + 3 * Math.random()
                        };
                    this.grid.addWidget($('<div><div class="grid-stack-item-content" /><div/>'),
                        node.x, node.y, node.width, node.height);
                    return false;
                }.bind(this);

                $('#add-new-widget').click(this.addNewWidget);
            };
        });
    </script>

    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="../bower_components/bootstrap/dist/js/bootstrap.js"></script>
    <script src="../bower_components/lodash/dist/lodash.js"></script>
    <script src="../src/gridstack.js"></script>
    <script src="../src/gridstack.jQueryUI.js"></script>
</body>
</html>